# ダッシュボード概要 (v2 – 2 タブ構成)

## 1. 目的

本書は、**Commit Coach ダッシュボード**を **2 つのタブレイアウト**（`Plan` / `Work`）へリファクタリングした後の、上位仕様・ユーザー体験・スコープを定義します。`commit_coach/x_docs_refactiring` に含まれる旧 `01_dashboard_overview.md` を置き換え、従来抜けていた **編集フロー** を正式に組み込みます。

## 2. スコープ

* **対象範囲 (In Scope)**

  * ダッシュボードを 2 つの主要タブに全面再設計
  * *プロジェクト*・*タスク*・*サブタスク* の完全な CRUD（作成・閲覧・**更新**・削除）
  * 階層レベルごとのドラッグ & ドロップ並び替え
  * タブ間のリアルタイムステート同期
* **対象外 (Out of Scope)**

  * グローバル設定ページ（別 Epic で管理）
  * チームコラボレーション機能（マルチユーザ編集、コメント等）

## 3. 用語集

| 用語          | 定義                               |
| ----------- | -------------------------------- |
| **エンティティ**  | プロジェクト、タスク、サブタスクの総称              |
| **Plan タブ** | 計画に特化した左タブ：エンティティの作成・並び替えを行う     |
| **Work タブ** | 実行に最適化した右タブ：タイムトラッキング、ステータス更新を行う |
| **編集フロー**   | エンティティの名前・説明・期日をインラインで変更する UX    |

## 4. ユーザー体験概要

### 4.1 タブレイアウト

```
┌──────────────────────────────┐
│ 1️⃣ Plan │ 2️⃣ Work │
└──────────────────────────────┘
```

* **Plan タブ**（デフォルト）：プロジェクト → タスク → サブタスクのツリー表示 & ドラッグハンドル
* **Work タブ**：同一データをカンバン形式で表示
* 両タブは単一のグローバルストアを共有；タブ切替で未保存編集を失わない

### 4.2 編集フロー（追加）

| トリガー                        | 挙動                            |
| --------------------------- | ----------------------------- |
| エンティティタイトルを **ダブルクリック**     | タイトルが input に変わり、自動フォーカス      |
| ホバーツールバーの ✏️ アイコンを **クリック** | 説明・期日を編集できるポップオーバー開閉          |
| **Enter** / **Blur**        | `PATCH` 経由で変更を保存し、ローカルステートを更新 |
| **Esc**                     | 編集をキャンセルし、元の値を復帰              |

### 4.3 ドラッグと編集の衝突回避

* カード左端 **24 px** をドラッグ専用エリア（`cursor: grab`）に固定
* それ以外の領域を編集・選択ゾーンとする
* 編集モード中はドラッグイベントを一時無効化

## 5. 機能要件

| ID              | 優先度    | 説明                                             |
| --------------- | ------ | ---------------------------------------------- |
| **F-REQ-1.1**   | P0     | Plan タブで全エンティティを親子関係順に表示する                     |
| **F-REQ-1.2**   | P0     | エンティティをドラッグ & ドロップで並び替えできる                     |
| **F-REQ-2.1**   | P0     | *＋* ボタンでエンティティを追加できる                           |
| **F-REQ-3.1**   | P0     | 削除時に確認ダイアログを表示する                               |
| **F-REQ-3.2**   | P0     | エンティティを完了マーク可能；両タブに即時反映                        |
| **F-REQ-3.3**   | P0     | Work タブでステータス・経過時間・担当者を編集可能                    |
| **F-REQ-3.4.1** | **P0** | **タイトル編集**：ダブルクリックでリネーム                        |
| **F-REQ-3.4.2** | **P0** | **説明編集**：リッチテキストインラインエディタ                      |
| **F-REQ-3.4.3** | **P0** | **期日編集**：日付ピッカーポップオーバー                         |
| **F-REQ-3.4.4** | P1     | キーボードショートカット：`E`=編集開始、`Cmd/Ctrl+S`=保存          |
| **F-REQ-4.1**   | P0     | すべての Create/Update は `POST`/`PATCH` で楽観的 UI 反映 |
| **F-REQ-4.2**   | P0     | タブ切替で編集 input がアンマウントされない                      |

## 6. 非機能要件

* **パフォーマンス**：初回レンダリング ≤ 200 ms、ドラッグ遅延 ≤ 16 ms
* **アクセシビリティ**：WCAG 2.1 AA 準拠、キーボード操作対応、ARIA ラベル付与
* **国際化**：文言は i18n ファイルに格納、RTL レイアウトも動作確認

## 7. 状態管理概要

```
rootStore
 ├─ entities: Record<ProjectId, Project>
 ├─ order: string[]          // projectId の並び順
 ├─ editingItem: {
 │    type: "project" | "task" | "subtask",
 │    id:   string,
 │    field: "title" | "description" | "dueDate"
 │  } | null
 └─ ui: { activeTab: "plan" | "work" }
```

* **editingItem** がインラインエディタの状態を保持；タブ間で維持
* 永続化フロー：`mutateAsync` → onSuccess → `invalidate('project.*')`

## 8. API エンドポイント概要

| Method | Path               | Body (抜粋)                                     | 備考          |
| ------ | ------------------ | --------------------------------------------- | ----------- |
| POST   | `/v1/projects`     | `{ title, description? }`                     | Project を返却 |
| PATCH  | `/v1/projects/:id` | `{ title?, description?, dueDate? }`          | **新規**      |
| POST   | `/v1/tasks`        | `{ projectId, title }`                        | Task を返却    |
| PATCH  | `/v1/tasks/:id`    | `{ title?, description?, dueDate?, status? }` | **新規**      |
| ...    | ...                | ...                                           | ...         |

## 9. エラーハンドリング

* 4xx/5xx → トースト表示 + リトライボタン
* 楽観的保存失敗時：ローカル変更をロールバックし、再度エディタを開く

## 10. 受け入れ基準 (Acceptance Criteria)

1. **AC-01:** Plan タブで作成したエンティティが Work タブに即時表示される
2. **AC-02:** タスクの並び替えがリロード後も保持される
3. **AC-03:** Plan タブでタイトルを編集すると Work タブ側も更新される
4. **AC-04:** 期日編集時にサーバが 409 を返しても UI が破綻しない
5. **AC-05:** `Tab` キーで編集可能フィールドを順番に移動できる
6. **AC-06:** カードをドラッグ中に編集モードが作動しない
7. **AC-07:** インライン編集は `Enter` またはフォーカスアウトで必ず保存される

## 11. 未解決事項 / TODO

* サブタスクの説明はリッチテキスト対応かプレーンテキストか？
* タスク / サブタスクの期日は null 許容とするか？
* Work タブで長い説明を表示する際、ツールチップとモーダルどちらを採用？

---

© 2025 Commit Coach プロダクトチーム
