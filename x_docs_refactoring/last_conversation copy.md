# ğŸ› ï¸ Duplicateâ€‘Key Error æ’²æ»…æ‰‹é †æ›¸Â ï¼ˆCommitÂ Coachï¼‰

> **ç›®çš„**Â â€’ `Encountered two children with the same key` è­¦å‘Šã‚’è§£æ¶ˆã—ã¤ã¤ã€æ—¢å­˜ UI ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå´©å£Šï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚„ã‚¢ã‚¤ã‚³ãƒ³ã®ã‚ºãƒ¬ãƒ»é«˜ã•ã‚¸ãƒ£ãƒ³ãƒ—ï¼‰ã‚’èµ·ã“ã•ãªã„ã€‚
> **å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒ**Â â€’ `temp-branch`ï¼ˆé‹ç”¨ä¸­ï¼‰ â€» `x_docs_refactoring` ã§å¾Œç¶šã®å…¨é¢ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ãŒäºˆå®šã•ã‚Œã¦ã„ã‚‹ãŸã‚ **â€œæœ€å°ãƒ‘ãƒƒãƒâ€** ã§å¯¾å‡¦ã™ã‚‹ã€‚

---

## 1Â  åŸå› ã¾ã¨ã‚

| ç—‡çŠ¶                                                                           | æ ¹æœ¬åŸå›                                   | UI å´©ã‚Œã®å‰¯æ¬¡è¦å›                                                                                   |
| ---------------------------------------------------------------------------- | ------------------------------------- | ------------------------------------------------------------------------------------------- |
| Next.js devtools ã«<br>`Encountered two children with the same key, 'task-1'` | `project.tasks` é…åˆ—å†…ã«é‡è¤‡ `id` ãŒå­˜åœ¨ï¼ˆé€£ç•ªæ¡ç•ªï¼‰ | æš«å®šå¯¾å¿œã§ `key={id}-{index}` ã«ã—ãŸçµæœã€ä¸¦ã³æ›¿ãˆã§ `index` ãŒå¤‰åŒ– â†’ React ãŒ **åˆ¥è¦ç´ ã¨èª¤èª** ã—å†ãƒã‚¦ãƒ³ãƒˆ â†’ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå†è¨ˆç®—ãŒä¹±ã‚Œã‚‹ |

---

## 2Â  è§£æ±ºæ–¹é‡ï¼ˆ3 ã‚¹ãƒ†ãƒƒãƒ—ï¼‰

1. **ãƒ¦ãƒ‹ãƒ¼ã‚¯ ID ã¸å…¨é¢ç§»è¡Œ**Â â€’ `nanoid()` / UUIDã€‚
2. **ã‚­ãƒ¼ã¯å®‰å®š & ä¸€æ„**Â â€’ `key={task.id}` ã«æˆ»ã™ï¼ˆindex ã¯ä»˜ã‘ãªã„ï¼‰ã€‚
3. **æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**Â â€’ é‡è¤‡ã‚’æ’é™¤ã—ã¦ã‹ã‚‰ãƒ‡ãƒ—ãƒ­ã‚¤ã€‚

> **ç•™æ„:** `x_docs_refactoring` ã§ã¯ DB ã‚¹ã‚­ãƒ¼ãƒå†è¨­è¨ˆãŒäºˆå®šã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã“ã“ã§ã¯ **ãƒ¢ãƒ‡ãƒ« / API ã‚’å£Šã•ãªã„ç¯„å›²ã§** å¯¾å¿œã™ã‚‹ã€‚

---

## 3Â  å®Ÿè£…æ‰‹é †

### 3â€‘1Â  ä¾å­˜è¿½åŠ 

```bash
pnpm add nanoid
```

### 3â€‘2Â  ID ç”Ÿæˆãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼ˆ`apps/frontend/lib/createTask.ts` ãªã©ï¼‰

```ts
import { nanoid } from "nanoid";
import type { Task } from "@/types";

export const createTask = (overrides: Partial<Task> = {}): Task => ({
  id: nanoid(),          // ã¶ã¤ã‹ã‚‰ãªã„ ID
  title: "æ–°ã—ã„ã‚¿ã‚¹ã‚¯",
  completed: false,
  expanded: true,
  startTime: null,
  endTime: null,
  subtasks: [],
  ...overrides,
});
```

### 3â€‘3Â  è¿½åŠ ç³»ãƒãƒ³ãƒ‰ãƒ©ã‚’ç½®æ›

`DashboardNestedList.tsx` / `useDashboard.ts` ç­‰ã® *é€£ç•ªæ¡ç•ªãƒ­ã‚¸ãƒƒã‚¯* ã‚’ã™ã¹ã¦ `createTask()` ã¸ç½®æ›ã€‚

```diff
- const newTaskId = `task-${project.tasks.length + 1}`;
- const newTask: Task = { id: newTaskId, ... };
+ const newTask = createTask();
```

â€» ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–¢æ•°å†…ã§ `nanoid()` ã‚’å‘¼ã°ãªã„ã“ã¨ï¼ˆStrictMode 2 å›ãƒ¬ãƒ³ãƒ€ãƒ¼ã§ ID ãŒå¤‰ã‚ã‚‹ï¼‰ã€‚

### 3â€‘4Â  DOM ã‚­ãƒ¼ã‚’ç´”ç²‹åŒ–

```diff
- key={`${task.id}-${index}`}
+ key={task.id}
```

> **ãƒ•ã‚§ãƒ¼ãƒ«ã‚»ãƒ¼ãƒ•ä¸è¦** â€” ID ãŒæœ¬å½“ã«ä¸€æ„ãªã‚‰ `index` ä»˜ãã‚­ãƒ¼ã¯ç™¾å®³ã‚ã£ã¦ä¸€åˆ©ãªã—ã€‚

### 3â€‘5Â  æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

* Supabase ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆï¼š

  ```sql
  UPDATE tasks SET id = gen_random_uuid() WHERE id IN (
    SELECT id FROM tasks GROUP BY id HAVING COUNT(*) > 1
  );
  ```
* ã‚ã‚‹ã„ã¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆä¾‹ï¼š`scripts/dedupeTaskIds.ts`ï¼ˆâ€»è©³ç´°ã¯ãƒªãƒã‚¸ãƒˆãƒªå‚ç…§ï¼‰ã€‚

> **ãƒ‡ãƒ—ãƒ­ã‚¤é †åº**
> 1ï¸âƒ£ DB ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ â†’ 2ï¸âƒ£ FE ãƒ‡ãƒ—ãƒ­ã‚¤ã€€ï¼ˆID ãŒä¸€æ„ã§ã‚ã‚‹ã“ã¨ã‚’å…ˆã«ä¿è¨¼ï¼‰

---

## 4Â  å‹•ä½œç¢ºèªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

* [ ] ã‚¿ã‚¹ã‚¯ 50 ä»¶é€£ç¶šè¿½åŠ ã—ã¦ã‚‚è­¦å‘Šã‚¼ãƒ­
* [ ] Today â†” Unscheduled ã§ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—å¾Œã‚‚è­¦å‘Šï¼UI æ­ªã¿ãªã—
* [ ] ãƒšãƒ¼ã‚¸é·ç§» â†’ æˆ»ã£ã¦ã‚‚ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ãƒ»å±•é–‹çŠ¶æ…‹ãŒç¶­æŒ
* [ ] CI / ESLint / Jest ã™ã¹ã¦ã‚°ãƒªãƒ¼ãƒ³

---

## 5Â  å°†æ¥ãƒªãƒ•ã‚¡ã‚¯ã‚¿ã¨ã®æ•´åˆ (x\_docs\_refactoring)

| åŒºåˆ†  | ä»Šå›ã®å¯¾å¿œ           | å°†æ¥ã®è¨ˆç”» (refactor doc)    | è¡çªãƒªã‚¹ã‚¯ | å›é¿ç­–                       |
| --- | --------------- | ----------------------- | ----- | ------------------------- |
| DB  | `uuid` å‹ã‚«ãƒ©ãƒ è¿½åŠ ã®ã¿ | ãƒ†ãƒ¼ãƒ–ãƒ«å†è¨­è¨ˆï¼æ­£è¦åŒ–             | **ä½** | ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ¥ PR ã«åˆ†é›¢     |
| API | ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä»•æ§˜å¤‰æ›´ãªã—   | REST â†’ tRPC ç§»è¡Œ          | ä¸­     | å‹å…±æœ‰å±¤ã‚’ `@/schema` ã«æŠ½å‡º      |
| FE  | ID ç”Ÿæˆã¨ key ä¿®æ­£   | Zustand â†’ Redux Toolkit | ä½     | `createTask` ã‚’ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£å±¤ã«æ®‹ã™ |

> **ãƒ¡ãƒ¢:** æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§è§¦ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ *refactor ãƒ–ãƒ©ãƒ³ãƒã§ã‚‚å†åˆ©ç”¨* ã•ã‚Œã‚‹ãŸã‚ã€ãƒ‘ã‚¹ & ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆåã‚’å¤‰æ›´ã—ãªã„ã“ã¨ã€‚

---

## 6Â  Git é‹ç”¨ä¾‹

```bash
# 1. ä½œæ¥­ãƒ–ãƒ©ãƒ³ãƒ
git checkout -b fix/duplicate-key-temp

# 2. ã‚³ãƒ¼ãƒ‰ä¿®æ­£ & DB ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
pnpm run migrate:dedupe-ids
pnpm test && pnpm lint

# 3. ã‚³ãƒŸãƒƒãƒˆ
git add .
git commit -m "fix: use nanoid and drop index key to resolve duplicateâ€‘key warning"

# 4. PR ä½œæˆï¼ˆã‚¿ã‚¤ãƒˆãƒ«å¿…é ˆï¼‰
# "fix: duplicate key (temp hotfix)"
```

---

### AppendixÂ â€”Â ã‚ˆãã‚ã‚‹è½ã¨ã—ç©´

1. **Strictâ€‘Mode äºŒé‡ãƒ¬ãƒ³ãƒ€ãƒ¼** â€¦ ãƒãƒ³ãƒ‰ãƒ©å¤–ã« ID ç”Ÿæˆã‚’ç½®ãã€‚
2. **Framerâ€‘Motion ã® `layoutId` é‡è¤‡** â€¦ `id` ã¨åŒæœŸã•ã›ã‚‹ã€‚
3. **Immer ç›´æ›¸ãæ›´æ–°** â€¦ Draft æ›¸ãæ›ãˆãŒ key åˆ¤å®šã«å½±éŸ¿ã™ã‚‹å ´åˆã¯ `produce` ã‚’å¾¹åº•ã€‚

---

âœ… ä»¥ä¸Šã§ Duplicateâ€‘Key å•é¡Œã¨ UI æ­ªã¿ã®ä¸¡æ–¹ã‚’è§£æ¶ˆã§ãã¾ã™ã€‚
ç–‘å•ç‚¹ãƒ»è¿½åŠ èª¿æŸ»ãŒå¿…è¦ãªå ´åˆã¯ `@yourâ€‘slackâ€‘channel` ã¾ã§ã©ã†ãã€‚
